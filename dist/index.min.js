!function(e,t){if("function"==typeof define&&define.amd)define("vxe-table-plugin-virtual-tree",["exports","xe-utils"],t);else if("undefined"!=typeof exports)t(exports,require("xe-utils"));else{var n={exports:{}};t(n.exports,e.XEUtils),e.VXETablePluginVirtualTree=n.exports.default}}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e,d){"use strict";var t;function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function h(e,t,n){var i=n.index,r=n.items,a=1;return i&&(a=function e(t,n){var i=n[t.treeOpts.children],r=1;if(t.isTreeExpandByRow(n))for(var a=0;a<i.length;a++)r+=e(t,i[a]);return r}(t,r[i-1])),e.rowHeight*a-(i?1:12-u(t))}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.VXETablePluginVirtualTree=void 0,d=(t=d)&&t.__esModule?t:{default:t};var n={install:function(e){var t,n,i,r,a,f,v,s,l;n=(t=e).Vue,i=t.Table,r=t.Grid,a=t.setup,f=t.t,v=a(),s=Object.keys(i.props).filter(function(e){return-1===["data","treeConfig"].indexOf(e)}),l={name:"VxeVirtualTree",extends:r,data:function(){return{removeList:[]}},crested:function(){(this.keepSource||this.treeOpts.lazy)&&console.error("[plugin-virtual-tree] Unsupported parameters.")},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},treeOpts:function(){return Object.assign({children:"children",hasChild:"hasChild",indent:20},v.treeConfig,this.treeConfig)},renderClass:function(){var e,t=this.vSize;return["vxe-grid vxe-virtual-tree",(o(e={},"size--".concat(t),t),o(e,"t--animat",this.animat),o(e,"has--tree-line",this.treeConfig&&this.treeOpts.line),o(e,"is--maximize",this.isMaximized()),e)]},tableExtendProps:function(){var t=this,n={};return s.forEach(function(e){n[e]=t[e]}),n}},watch:{columns:function(){this.loadColumn(this.handleColumns())},data:function(e){this.loadData(e)}},created:function(){var e=this.data;Object.assign(this,{fullTreeData:[],tableData:[],fullTreeRowMap:new Map}),this.handleColumns(),e&&this.reloadData(e)},methods:{getTableOns:function(){var r=this,e=this.$listeners,t=this.proxyConfig,n=this.proxyOpts,a={};return d.default.each(e,function(e,i){a[i]=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r.$emit.apply(r,[i].concat(t))}}),a["checkbox-all"]=this.checkboxAllEvent,a["checkbox-change"]=this.checkboxChangeEvent,t&&(n.sort&&(a["sort-change"]=this.sortChangeEvent),n.filter&&(a["filter-change"]=this.filterChangeEvent)),a},renderTreeLine:function(e,t){var n=this.treeConfig,i=this.treeOpts,r=this.fullTreeRowMap,a=e.$table,s=e.row,l=e.column.treeNode;if(l&&n&&i.line){var o=s._X_LEVEL,c=r.get(s);return[l&&i.line?t("div",{class:"vxe-tree--line-wrapper"},[t("div",{class:"vxe-tree--line",style:{height:"".concat(h(a,this,c),"px"),left:"".concat(o*(i.indent||20)+(o?2-u(this):0)+16,"px")}})]):null]}return[]},renderTreeIcon:function(e,t,n){var i=this,r=e.isHidden,a=e.row,s=this.treeOpts,l=s.children,o=s.indent,c=s.trigger,u=s.iconOpen,h=s.iconClose,f=a[l],d=!1,p={};return r||(d=a._X_EXPAND),c&&"default"!==c||(p.click=function(){return i.toggleTreeExpand(a)}),[t("div",{class:["vxe-cell--tree-node",{"is--active":d}],style:{paddingLeft:"".concat(a._X_LEVEL*o,"px")}},[f&&f.length?[t("div",{class:"vxe-tree--btn-wrapper",on:p},[t("i",{class:["vxe-tree--node-btn",d?u||v.icon.TABLE_TREE_OPEN:h||v.icon.TABLE_TREE_CLOSE]})])]:null,t("div",{class:"vxe-tree-cell"},n)])]},_loadTreeData:function(e){var t=this,n=this.getRadioRecord();return this.$nextTick().then(function(){return t.$refs.xTable.loadData(e)}).then(function(){n&&t.setRadioRow(n)})},loadData:function(e){return this._loadTreeData(this.toVirtualTree(e))},reloadData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.reloadData(t.toVirtualTree(e))}).then(function(){return t.handleDefaultTreeExpand()})},isTreeExpandByRow:function(e){return!!e._X_EXPAND},setTreeExpansion:function(e,t){return this.setTreeExpand(e,t)},setTreeExpand:function(e,t){var n=this;return e&&(d.default.isArray(e)||(e=[e]),e.forEach(function(e){return n.virtualExpand(e,!!t)})),this._loadTreeData(this.tableData)},setAllTreeExpansion:function(e){return this.setAllTreeExpand(e)},setAllTreeExpand:function(e){return this._loadTreeData(this.virtualAllExpand(e))},toggleTreeExpansion:function(e){return this.toggleTreeExpand(e)},toggleTreeExpand:function(e){return this._loadTreeData(this.virtualExpand(e,!e._X_EXPAND))},getTreeExpandRecords:function(){var t=this.hasChilds,n=[];return d.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND&&t(e)&&n.push(e)},this.treeOpts),n},clearTreeExpand:function(){return this.setAllTreeExpand(!1)},handleColumns:function(){var n=this;return this.columns.map(function(e){if(e.treeNode){var t=e.slots||{};t.icon=n.renderTreeIcon,t.line=n.renderTreeLine,e.slots=t}return e})},hasChilds:function(e){var t=e[this.treeOpts.children];return t&&t.length},getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},isInsertByRow:function(e){return!!e._X_INSERT},getInsertRecords:function(){var t=[];return d.default.eachTree(this.fullTreeData,function(e){e._X_INSERT&&t.push(e)},this.treeOpts),t},insert:function(e){return this.insertAt(e)},insertAt:function(e,t){var n=this,i=this.fullTreeData,r=this.tableData,a=this.treeOpts;d.default.isArray(e)||(e=[e]);var s=e.map(function(e){return n.defineField(Object.assign({_X_EXPAND:!1,_X_INSERT:!0,_X_LEVEL:0},e))});if(t)if(-1===t)i.push.apply(i,s),r.push.apply(r,s);else{var l=d.default.findTree(i,function(e){return e===t},a);if(!l||-1===l.index)throw new Error(f("vxe.error.unableInsert"));var o=l.items,c=l.index,u=l.nodes,h=r.indexOf(t);-1<h&&r.splice.apply(r,[h,0].concat(s)),o.splice.apply(o,[c,0].concat(s)),s.forEach(function(e){e._X_LEVEL=u.length-1})}else i.unshift.apply(i,s),r.unshift.apply(r,s);return this._loadTreeData(r).then(function(){return{row:s.length?s[s.length-1]:null,rows:s}})},getRemoveRecords:function(){return this.removeList},removeSelecteds:function(){return this.removeCheckboxRow()},removeCheckboxRow:function(){var t=this;return this.remove(this.getSelectRecords()).then(function(e){return t.clearSelection(),e})},remove:function(e){var l=this,o=this.removeList,c=this.fullTreeData,u=this.treeOpts,h=[];return e?d.default.isArray(e)||(e=[e]):e=c,e.forEach(function(t){var e=d.default.findTree(c,function(e){return e===t},u);if(e){var n=e.item,i=e.items,r=e.index,a=e.parent;if(l.isInsertByRow(t)||o.push(t),a){var s=l.isTreeExpandByRow(a);s&&l.handleCollapsing(a),i.splice(r,1),s&&l.handleExpanding(a)}else l.handleCollapsing(n),i.splice(r,1),l.tableData.splice(l.tableData.indexOf(n),1);h.push(n)}}),this._loadTreeData(this.tableData).then(function(){return{row:h.length?h[h.length-1]:null,rows:h}})},handleDefaultTreeExpand:function(){var i=this,e=this.treeConfig,r=this.treeOpts,a=this.tableFullData;if(e){var s=r.children,t=r.expandAll,n=r.expandRowKeys;if(t)this.setAllTreeExpand(!0);else if(n){var l=this.rowId;n.forEach(function(t){var e=d.default.findTree(a,function(e){return t===d.default.get(e,l)},r),n=e?e.item[s]:0;n&&n.length&&i.setTreeExpand(e.item,!0)})}}},toVirtualTree:function(e){var s=this.fullTreeRowMap;return s.clear(),d.default.eachTree(e,function(e,t,n,i,r,a){e._X_EXPAND=!1,e._X_INSERT=!1,e._X_LEVEL=a.length-1,s.set(e,{item:e,index:t,items:n,paths:i,parent:r,nodes:a})}),this.fullTreeData=e.slice(0),this.tableData=e.slice(0),e},virtualExpand:function(e,t){return e._X_EXPAND!==t&&(e._X_EXPAND?this.handleCollapsing(e):this.handleExpanding(e)),this.tableData},handleExpanding:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeOpts,i=e[n.children],s=[],r=t.indexOf(e);if(-1===r)throw new Error("错误的操作！");d.default.eachTree(i,function(e,t,n,i,r,a){r&&!r._X_EXPAND||s.push(e)},n),e._X_EXPAND=!0,t.splice.apply(t,[r+1,0].concat(s))}return this.tableData},handleCollapsing:function(e){if(this.hasChilds(e)){var t=this.tableData,n=this.treeOpts,i=e[n.children],r=[];d.default.eachTree(i,function(e){r.push(e)},n),e._X_EXPAND=!1,this.tableData=t.filter(function(e){return-1===r.indexOf(e)})}return this.tableData},virtualAllExpand:function(t){var e=this.treeOpts;if(t){var n=[];d.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND=t,n.push(e)},e),this.tableData=n}else d.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND=t},e),this.tableData=this.fullTreeData.slice(0);return this.tableData},checkboxAllEvent:function(e){var t=this.checkboxConfig,n=void 0===t?{}:t,i=this.treeOpts,r=n.checkField,a=n.halfField,s=n.checkStrictly,l=e.checked;r&&!s&&d.default.eachTree(this.fullTreeData,function(e){e[r]=l,a&&(e[a]=!1)},i),this.$emit("checkbox-all",e)},checkboxChangeEvent:function(e){var t=this.checkboxConfig,n=void 0===t?{}:t,i=this.treeOpts,r=n.checkField,a=n.halfField,s=n.checkStrictly,l=e.row,o=e.checked;r&&!s&&(d.default.eachTree([l],function(e){e[r]=o,a&&(e[a]=!1)},i),this.checkParentNodeSelection(l)),this.$emit("checkbox-change",e)},checkParentNodeSelection:function(t){var e=this.checkboxConfig,n=void 0===e?{}:e,i=this.treeOpts,r=i.children,a=n.checkField,s=n.halfField,l=n.checkStrictly,o=d.default.findTree(this.fullTreeData,function(e){return e===t},i);if(o&&a&&!l){var c=o.parent;if(c){var u=c[r].every(function(e){return e[a]});s&&!u&&(c[s]=c[r].some(function(e){return e[a]||e[s]})),c[a]=u,this.checkParentNodeSelection(c)}else this.$refs.xTable.checkSelectionStatus()}},getCheckboxRecords:function(){var e=this.checkboxConfig,t=void 0===e?{}:e,n=this.treeOpts,i=t.checkField;if(i){var r=[];return d.default.eachTree(this.fullTreeData,function(e){e[i]&&r.push(e)},n),r}return this.$refs.xTable.getCheckboxRecords()},getCheckboxIndeterminateRecords:function(){var e=this.checkboxConfig,t=void 0===e?{}:e,n=this.treeOpts,i=t.halfField;if(i){var r=[];return d.default.eachTree(this.fullTreeData,function(e){e[i]&&r.push(e)},n),r}return this.$refs.xTable.getCheckboxIndeterminateRecords()}}},n.component(l.name,l)}};e.VXETablePluginVirtualTree=n,"undefined"!=typeof window&&window.VXETable&&window.VXETable.use(n);var i=n;e.default=i});